const axios = require('axios');
require('dotenv').config();

const API_KEY = process.env.GEMINI_API_KEY;

async function generateResponse(userMessage, contextData) {
    if (!API_KEY) {
        console.error("Gemini API Key is missing.");
        return "à¸‚à¸­à¸­à¸ à¸±à¸¢ à¸£à¸°à¸šà¸š AI à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ (à¸•à¸´à¸”à¸•à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ)";
    }

    const systemInstruction = `
à¸„à¸¸à¸“à¸„à¸·à¸­ à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸”à¸¹à¹à¸¥à¹€à¸žà¸ˆ Facebook à¸‚à¸­à¸‡à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¹à¸žà¸—à¸¢à¹Œà¹à¸¥à¸°à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸ªà¸¸à¸‚à¸ à¸²à¸ž
à¸¡à¸µà¸šà¸¸à¸„à¸¥à¸´à¸à¸ªà¸¸à¸ à¸²à¸ž à¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£ à¸­à¸šà¸­à¸¸à¹ˆà¸™ à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹à¸¥à¸°à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸œà¸¹à¹‰à¸ªà¸­à¸šà¸–à¸²à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸•à¹‡à¸¡à¹ƒà¸ˆ
à¹ƒà¸Šà¹‰à¸ªà¸£à¸£à¸žà¸™à¸²à¸¡à¸œà¸¹à¹‰à¸«à¸à¸´à¸‡ à¹à¸¥à¸°à¸•à¸­à¸šà¸”à¹‰à¸§à¸¢à¸ à¸²à¸©à¸²à¸žà¸¹à¸”à¸—à¸µà¹ˆà¸ªà¸¸à¸ à¸²à¸ž à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢ à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¸ˆà¸™à¹€à¸à¸´à¸™à¹„à¸›
à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­:
1. à¸—à¸±à¸à¸—à¸²à¸¢à¹à¸¥à¸°à¸Šà¸§à¸™à¸„à¸¸à¸¢à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´
   - à¸«à¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸žà¸´à¸¡à¸žà¹Œà¸§à¹ˆà¸² â€œà¸ªà¸§à¸±à¸ªà¸”à¸µâ€, â€œà¸ªà¸­à¸šà¸–à¸²à¸¡à¸„à¹ˆà¸°/à¸„à¸£à¸±à¸šâ€, â€œà¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸™à¹ˆà¸­à¸¢â€ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸”à¹‰à¸§à¸¢à¸„à¸³à¸—à¸±à¸à¸—à¸²à¸¢à¸—à¸µà¹ˆà¸ªà¸¸à¸ à¸²à¸ž à¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡ à¹€à¸Šà¹ˆà¸™ â€œà¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° ðŸ˜Š à¸¢à¸´à¸™à¸”à¸µà¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¸°à¸„à¸° à¸ªà¸™à¹ƒà¸ˆà¸ªà¸­à¸šà¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹ƒà¸”à¹€à¸›à¹‡à¸™à¸žà¸´à¹€à¸¨à¸©à¸„à¸°â€
2. à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ â€œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸£à¸°à¸šà¸šâ€ à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
   - à¸­à¸˜à¸´à¸šà¸²à¸¢à¸”à¹‰à¸§à¸¢à¸ à¸²à¸©à¸²à¸„à¸™à¸—à¸±à¹ˆà¸§à¹„à¸› à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢ à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™ à¸œà¸¹à¹‰à¸›à¸à¸„à¸£à¸­à¸‡ à¹à¸¥à¸°à¸šà¸¸à¸„à¸„à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›
3. à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”à¸ªà¸³à¸„à¸±à¸ (à¸«à¹‰à¸²à¸¡à¸à¹ˆà¸²à¸à¸·à¸™à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”)
   - à¸«à¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ à¹€à¸‰à¸žà¸²à¸°à¹€à¸ˆà¸²à¸°à¸ˆà¸‡ à¸«à¸£à¸·à¸­ à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸£à¸°à¸šà¸š
   - à¸«à¸£à¸·à¸­à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹ƒà¸ˆ / à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸°à¸šà¸¸à¹„à¸§à¹‰à¸Šà¸±à¸”à¹€à¸ˆà¸™
   - à¸•à¹‰à¸­à¸‡à¸•à¸­à¸šà¸”à¹‰à¸§à¸¢à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ â€œà¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¸‰à¸±à¸™à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰ à¸£à¸šà¸à¸§à¸™à¸žà¸´à¸¡à¸žà¹Œ 'à¸•à¸´à¸”à¸•à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ' à¹‚à¸”à¸¢à¸•à¸£à¸‡à¸™à¸°à¸„à¸°â€
   - à¸«à¹‰à¸²à¸¡à¹€à¸”à¸² à¸«à¹‰à¸²à¸¡à¸ªà¸¡à¸¡à¸•à¸´ à¸«à¸£à¸·à¸­à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸¶à¹‰à¸™à¸¡à¸²à¹€à¸­à¸‡à¹‚à¸”à¸¢à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
4. à¸ªà¹„à¸•à¸¥à¹Œà¸à¸²à¸£à¸•à¸­à¸š
   - à¸ªà¸¸à¸ à¸²à¸ž à¸™à¹ˆà¸²à¸Ÿà¸±à¸‡ à¹ƒà¸ˆà¹€à¸¢à¹‡à¸™
   - à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸—à¸²à¸‡à¸à¸²à¸£à¸«à¸£à¸·à¸­à¸£à¸²à¸Šà¸à¸²à¸£à¹€à¸à¸´à¸™à¹„à¸›
   - à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¹€à¸«à¸¡à¸·à¸­à¸™ â€œà¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸œà¸¹à¹‰à¸«à¸à¸´à¸‡à¸—à¸µà¹ˆà¸žà¸£à¹‰à¸­à¸¡à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­â€
   
à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸£à¸°à¸šà¸š (Context):
${contextData}
`;

    const models = [
        "gemini-2.5-flash",
        "gemini-2.0-flash",
        "gemini-flash-latest",
        "gemini-pro-latest",
        "gemini-1.5-flash",
        "gemini-1.5-flash-latest",
        "gemini-pro"
    ];

    for (const model of models) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;

        console.log(`Trying model: ${model}...`);

        const requestBody = {
            contents: [
                {
                    parts: [
                        { text: systemInstruction + "\n\nà¸„à¸³à¸–à¸²à¸¡: " + userMessage }
                    ]
                }
            ]
        };

        try {
            const response = await axios.post(url, requestBody, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.data && response.data.candidates && response.data.candidates.length > 0) {
                const aiText = response.data.candidates[0].content.parts[0].text;
                return aiText;
            }
            // If we get here but no candidates, it's a valid response but empty. 
            // Arguably we should just return, but maybe try next model? 
            // For now, let's assume empty candidates is a failure of the model generation, not connection.
            // But usually 404 is the connection/model error.

        } catch (error) {
            console.error(`Error with model ${model}:`, error.message);

            if (error.response) {
                // If it's 404, we continue to next model
                if (error.response.status === 404) {
                    console.log(`Model ${model} not found (404), trying next...`);
                    continue;
                }
                // If other error (400, 403, 500), it might be request body or key issue, so maybe don't retry?
                // But specifically for 'Not Found' (404) or 'Method Not Allowed' (405) we should retry.
                if (error.response.status !== 404) {
                    console.error('Response Data:', JSON.stringify(error.response.data));
                }
            }
        }
    }

    return "à¸‚à¸­à¸­à¸ à¸±à¸¢ à¸£à¸°à¸šà¸š AI à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰ (All models failed)";
}

module.exports = {
    generateResponse
};
